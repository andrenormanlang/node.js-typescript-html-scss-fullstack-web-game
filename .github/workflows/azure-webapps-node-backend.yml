name: Build and deploy backend to Azure Web App

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: read

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "22.x"
                  cache: "npm"
                  cache-dependency-path: backend/package-lock.json

            - name: Install dependencies
              working-directory: backend
              run: npm ci

            - name: Build
              working-directory: backend
              run: npm run build

            - name: Prune to production dependencies
              working-directory: backend
              run: npm prune --omit=dev

            - name: Create deployment package
              run: |
                  cd backend
                  zip -r ../backend-deploy.zip .

            - name: Validate publish profile secret
              env:
                PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE || secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
              run: |
                if [ -z "$PUBLISH_PROFILE" ]; then
                  echo "Missing publish profile secret. Set either AZURE_WEBAPP_PUBLISH_PROFILE or AZUREAPPSERVICE_PUBLISHPROFILE in GitHub repo secrets."
                  exit 1
                fi

            - name: Deploy to Azure Web App
              uses: azure/webapps-deploy@v3
              with:
                  app-name: ktv-api
                  publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE || secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
                  package: backend-deploy.zip
